
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å››å¤§é¼ ç‹ä¸‹ç­æº–å‚™</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6; /* Tailwind gray-100 */
        }
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            padding-top: 60px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 0.5rem;
            text-align: center;
            position: relative;
        }
        .close-button {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
        }
        .loading-spinner { /* For general page/modal loading */
            border: 4px solid #f3f3f3; 
            border-top: 4px solid #3498db; 
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        .button-loading .loading-spinner-small { /* For buttons */
            width: 16px;
            height: 16px;
            border-width: 2px;
            border-style: solid;
            border-color: transparent; /* Transparent base */
            border-top-color: currentColor; /* Use button's text color for spinner top */
            border-radius: 50%;
            display: inline-block; 
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
        }
        .note-suggestion-item {
            display: block;
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border: 1px solid #e5e7eb; 
            border-radius: 0.375rem; 
            cursor: pointer;
            text-align: left;
            background-color: #f9fafb; 
        }
        .note-suggestion-item:hover {
            background-color: #f3f4f6; 
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-5xl">
        <header class="mb-8 text-center">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-700">å››å¤§é¼ ç‹ä¸‹ç­æº–å‚™</h1>
            <p class="text-sm text-gray-500 mt-2">App ID: <span id="appIdDisplay"></span> | User ID: <span id="userIdDisplay"></span></p>
        </header>

        <div id="messageArea" class="mb-4 p-3 rounded-md text-sm hidden"></div>

        <section class="bg-white p-6 rounded-lg shadow-lg mb-8">
            <h2 class="text-2xl font-semibold mb-6 text-gray-700">è¨˜éŒ„ä¸‹ç­æ™‚é–“</h2>
            <form id="leaveForm" class="space-y-6">
                <div>
                    <label for="teamMember" class="block text-sm font-medium text-gray-700 mb-1">åœ˜éšŠæˆå“¡</label>
                    <select id="teamMember" name="teamMember" required class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option value="DK0">DK0</option>
                        <option value="DKBS">DKBS</option>
                        <option value="RPDSH">RPDSH</option>
                        <option value="RPGJS">RPGJS</option>
                    </select>
                </div>
                
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
                    <div class="sm:col-span-1">
                        <label for="entryDate" class="block text-sm font-medium text-gray-700 mb-1">æ—¥æœŸ</label>
                        <input type="date" id="entryDate" name="entryDate" required class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div class="sm:col-span-1">
                        <label for="clockOutTime" class="block text-sm font-medium text-gray-700 mb-1">ä¸‹ç­æ™‚é–“</label>
                        <input type="time" id="clockOutTime" name="clockOutTime" required class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div class="sm:col-span-1">
                        <button type="button" id="refreshDateTimeButton" class="w-full mt-1 py-2 px-3 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-500 hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-400 flex items-center justify-center">
                            ğŸ”„ æ›´æ–°ç‚ºç¾åœ¨
                        </button>
                    </div>
                </div>

                <div>
                    <div class="flex justify-between items-center mb-1">
                        <label for="notes" class="block text-sm font-medium text-gray-700">å‚™è¨» (å¯é¸)</label>
                        <button type="button" id="getNoteSuggestionButton" class="text-xs py-1 px-2 bg-teal-500 hover:bg-teal-600 text-white rounded-md shadow-sm flex items-center disabled:opacity-50">
                            <span>ğŸ’¡ å‚™è¨»å»ºè­°</span>
                        </button>
                    </div>
                    <textarea id="notes" name="notes" rows="3" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="ä¾‹å¦‚ï¼šåŠ ç­æ™šèµ°åŸå› ..."></textarea>
                </div>
                <div>
                    <button type="submit" id="submitButton" class="w-full flex justify-center items-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50">
                        <span>è¨˜éŒ„æ™‚é–“</span>
                    </button>
                </div>
            </form>
        </section>

        <section class="bg-white p-6 rounded-lg shadow-lg mb-8">
            <h2 class="text-2xl font-semibold mb-6 text-gray-700">âœ¨ é¼ ç‹æ‘¸é­šå°å·¥å…· âœ¨</h2>
            <div class="space-y-4">
                <button id="getExcuseButton" class="w-full flex justify-center items-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-500 hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-400 disabled:opacity-50">
                    <span>ğŸ‘‘ è³œæˆ‘ä¸‹ç­ç¥è—‰å£ï¼</span>
                </button>
                </div>
        </section>

        <section class="bg-white p-6 rounded-lg shadow-lg">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-700 mb-3 sm:mb-0">ä¸‹ç­æ™‚é–“è¨˜éŒ„</h2>
                <button id="overallReviewButton" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-md shadow-sm text-sm font-medium flex items-center justify-center disabled:opacity-50">
                    <span>âœ¨ ç²å–è¿‘æœŸè¡¨ç¾ç¸½è©•</span>
                </button>
            </div>
            <div id="loadingEntries" class="text-center py-4">
                <div class="loading-spinner"></div>
                <p class="text-sm text-gray-500 mt-2">è¼‰å…¥è¨˜éŒ„ä¸­...</p>
            </div>
            <div id="noEntries" class="text-center py-4 text-gray-500 hidden">ç›®å‰æ²’æœ‰è¨˜éŒ„ã€‚</div>
            <div class="overflow-x-auto">
                <table id="leaveTable" class="min-w-full divide-y divide-gray-200 hidden">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ—¥æœŸ</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åœ˜éšŠæˆå“¡</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ä¸‹ç­æ™‚é–“</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å‚™è¨»</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é¼ ç‹å»ºè­° âœ¨</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="leaveList" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
        </section>
    </div>

    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeConfirmationModal()">&times;</span>
            <h3 id="modalTitle" class="text-lg font-medium leading-6 text-gray-900 mb-2">ç¢ºèªæ“ä½œ</h3>
            <p id="modalMessage" class="text-sm text-gray-500 mb-4">æ‚¨ç¢ºå®šå—ï¼Ÿ</p>
            <div class="mt-4 flex justify-end space-x-3">
                <button id="modalCancelButton" type="button" class="inline-flex justify-center rounded-md border border-gray-300 px-4 py-2 bg-white text-base font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:text-sm">
                    å–æ¶ˆ
                </button>
                <button id="modalConfirmButton" type="button" class="inline-flex justify-center rounded-md border border-transparent px-4 py-2 bg-red-600 text-base font-medium text-white shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:text-sm">
                    ç¢ºèª
                </button>
            </div>
        </div>
    </div>

    <div id="suggestionModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeSuggestionModal()">&times;</span>
            <h3 id="suggestionModalTitle" class="text-xl font-semibold text-indigo-600 mb-4">âœ¨ é¼ ç‹çµ¦ä½ çš„å»ºè­° âœ¨</h3>
            <div id="suggestionLoading" class="my-4">
                <div class="loading-spinner"></div>
                <p class="text-sm text-gray-500 mt-2">é¼ ç‹æ­£åœ¨æ€è€ƒä¸­...</p>
            </div>
            <div id="suggestionText" class="text-gray-700 text-lg" style="white-space: pre-wrap;"></div>
            <button id="closeSuggestionButton" type="button" class="mt-6 inline-flex justify-center rounded-md border border-transparent px-4 py-2 bg-indigo-600 text-base font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:text-sm">
                æœ•çŸ¥é“äº†
            </button>
        </div>
    </div>

  <script type="module">
    // Firebase SDKs (Version 11.8.1)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import {
        getAuth,
        signInAnonymously,
        signInWithCustomToken,
        onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
    import {
        getFirestore,
        collection,
        addDoc,
        onSnapshot,
        query,
        orderBy,
        serverTimestamp,
        doc,
        deleteDoc,
        setLogLevel
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
    // *** æ–°å¢ï¼šå¼•å…¥ Firebase Functions SDK ***
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-functions.js";


    // --- Configuration ---
    const firebaseConfig = {
        apiKey: "AIzaSyDwcwQ_MjTC9FeHwJYybqXwXkWe-m9kFss", // è«‹ç¢ºèªé€™æ˜¯æ‚¨ Firebase å°ˆæ¡ˆçš„çœŸå¯¦é‡‘é‘°
        authDomain: "rat-king-clock-tracking-app.firebaseapp.com",
        projectId: "rat-king-clock-tracking-app",
        storageBucket: "rat-king-clock-tracking-app.firebasestorage.app",
        messagingSenderId: "823760126516",
        appId: "1:823760126516:web:6ba1cdf5ee2829725d8061",
        measurementId: "G-MVZZ1359XH"
    };

    const initialAuthToken = null;
    const appId = firebaseConfig.appId;

    // --- Firebase Initialization ---
    let app;
    let auth;
    let db;
    let functionsService; // *** æ–°å¢ï¼šç”¨æ–¼ Firebase Functions æœå‹™ ***

    let currentUserId = null;
    let clockOutCollectionRef;
    let unsubscribeClockOutListener = null;
    let allFetchedEntries = [];

    // --- UI Elements ---
    const appIdDisplayElement = document.getElementById('appIdDisplay');
    const userIdDisplayElement = document.getElementById('userIdDisplay');
    if (appIdDisplayElement) appIdDisplayElement.textContent = appId;

    const leaveForm = document.getElementById('leaveForm');
    const entryDateInput = document.getElementById('entryDate');
    const clockOutTimeInput = document.getElementById('clockOutTime');
    const notesInput = document.getElementById('notes');
    const refreshDateTimeButton = document.getElementById('refreshDateTimeButton');
    const getNoteSuggestionButton = document.getElementById('getNoteSuggestionButton');
    const getExcuseButton = document.getElementById('getExcuseButton');
    const submitButton = document.getElementById('submitButton');
    const leaveList = document.getElementById('leaveList');
    const loadingEntries = document.getElementById('loadingEntries');
    const noEntries = document.getElementById('noEntries');
    const leaveTable = document.getElementById('leaveTable');
    const messageArea = document.getElementById('messageArea');
    const overallReviewButton = document.getElementById('overallReviewButton');

    const confirmationModal = document.getElementById('confirmationModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalMessage = document.getElementById('modalMessage');
    const modalConfirmButton = document.getElementById('modalConfirmButton');
    const modalCancelButton = document.getElementById('modalCancelButton');
    let confirmActionCallback = null;

    const suggestionModal = document.getElementById('suggestionModal');
    const suggestionModalTitle = document.getElementById('suggestionModalTitle');
    const suggestionText = document.getElementById('suggestionText');
    const suggestionLoading = document.getElementById('suggestionLoading');
    const closeSuggestionButton = document.getElementById('closeSuggestionButton');

    // --- Helper Functions ---
    function showMessage(message, type = 'success') {
        if (!messageArea) return;
        messageArea.textContent = message;
        messageArea.classList.remove('hidden', 'bg-green-100', 'text-green-700', 'bg-red-100', 'text-red-700', 'bg-yellow-100', 'text-yellow-700');
        if (type === 'success') messageArea.classList.add('bg-green-100', 'text-green-700');
        else if (type === 'error') messageArea.classList.add('bg-red-100', 'text-red-700');
        else if (type === 'warning') messageArea.classList.add('bg-yellow-100', 'text-yellow-700');
        messageArea.classList.remove('hidden');
        setTimeout(() => messageArea.classList.add('hidden'), 5000);
    }

    function openConfirmationModal(title, message, onConfirm) {
        if (!confirmationModal || !modalTitle || !modalMessage) return;
        modalTitle.textContent = title;
        modalMessage.textContent = message;
        confirmActionCallback = onConfirm;
        confirmationModal.style.display = 'block';
    }

    window.closeConfirmationModal = function() {
        if (!confirmationModal) return;
        confirmationModal.style.display = 'none';
        confirmActionCallback = null;
    }

    if (modalCancelButton) modalCancelButton.onclick = window.closeConfirmationModal;
    if (modalConfirmButton) modalConfirmButton.onclick = () => {
        if (confirmActionCallback) confirmActionCallback();
        window.closeConfirmationModal();
    };
    
    function openSuggestionModal(modalType = 'individual') { 
        if (!suggestionModal || !suggestionText || !suggestionLoading || !suggestionModalTitle || !closeSuggestionButton) return;
        suggestionText.innerHTML = ''; 
        suggestionLoading.style.display = 'block';
        closeSuggestionButton.classList.remove('hidden'); 

        if (modalType === 'overall') {
            suggestionModalTitle.textContent = 'âœ¨ é¼ ç‹è¿‘æœŸè¡¨ç¾ç¸½è©• âœ¨';
        } else if (modalType === 'note') {
            suggestionModalTitle.textContent = 'âœ¨ é¼ ç‹å‚™è¨»éˆæ„Ÿ âœ¨';
        } else if (modalType === 'excuse') { 
            suggestionModalTitle.textContent = 'âœ¨ é¼ ç‹è„«é€ƒå¯†æŠ€ âœ¨';
        } else { 
            suggestionModalTitle.textContent = 'âœ¨ é¼ ç‹çµ¦ä½ çš„å»ºè­° âœ¨';
        }
        suggestionModal.style.display = 'block';
    }

    window.closeSuggestionModal = function() {
        if (!suggestionModal) return;
        suggestionModal.style.display = 'none';
    }
    if (closeSuggestionButton) closeSuggestionButton.onclick = window.closeSuggestionModal;

    window.onclick = (event) => { 
        if (event.target == confirmationModal) window.closeConfirmationModal();
        if (event.target == suggestionModal) window.closeSuggestionModal();
    };

    function setCurrentDateTime() {
        if (!entryDateInput || !clockOutTimeInput) return;
        const now = new Date();
        const year = now.getFullYear();
        const month = (now.getMonth() + 1).toString().padStart(2, '0');
        const day = now.getDate().toString().padStart(2, '0');
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');

        entryDateInput.value = `${year}-${month}-${day}`;
        clockOutTimeInput.value = `${hours}:${minutes}`;
    }
    
    if (refreshDateTimeButton) refreshDateTimeButton.addEventListener('click', setCurrentDateTime);

    // --- Firebase Core Functions ---
    async function initializeFirebaseServices() {
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            functionsService = getFunctions(app, "us-central1"); // *** åˆå§‹åŒ– Functions æœå‹™ï¼Œå€åŸŸè«‹èˆ‡æ‚¨éƒ¨ç½²çš„å‡½å¼å€åŸŸä¸€è‡´ ***
            setLogLevel('debug');

            const collectionPath = `artifacts/${appId}/public/data/clockOutEntries`;
            clockOutCollectionRef = collection(db, collectionPath);
            console.log("ä½¿ç”¨ Firestore é›†åˆ:", collectionPath);

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUserId = user.uid;
                    if (userIdDisplayElement) userIdDisplayElement.textContent = currentUserId;
                    console.log("ç”¨æˆ¶å·²é€šé UID é©—è­‰:", currentUserId);
                    fetchAndDisplayEntries();
                } else {
                    currentUserId = crypto.randomUUID();
                    if (userIdDisplayElement) userIdDisplayElement.textContent = `${currentUserId} (åŒ¿å)`;
                    console.log("ç”¨æˆ¶æœªç¶“é©—è­‰ï¼Œä½¿ç”¨åŒ¿å ID:", currentUserId);
                    if (initialAuthToken) {
                        signInWithCustomToken(auth, initialAuthToken)
                            .catch((error) => {
                                console.error("ä½¿ç”¨è‡ªè¨‚ä»¤ç‰Œç™»å…¥æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
                                signInAnonymously(auth).catch(err => console.error("ä»¤ç‰Œå¤±æ•—å¾ŒåŒ¿åç™»å…¥æ™‚ç™¼ç”ŸéŒ¯èª¤:", err));
                            });
                    } else {
                        signInAnonymously(auth).catch(err => console.error("åŒ¿åç™»å…¥æ™‚ç™¼ç”ŸéŒ¯èª¤:", err));
                    }
                }
            });
        } catch (error) {
            console.error("åˆå§‹åŒ– Firebase æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
            showMessage("åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼æœå‹™æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚è«‹ç¨å¾Œå†è©¦ã€‚", "error");
            if (loadingEntries) loadingEntries.textContent = "åˆå§‹åŒ–éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°ã€‚";
        }
    }

    async function addEntry(teamMember, entryDate, clockOutTime, notes) {
        if (!db || !clockOutCollectionRef) {
            showMessage("è³‡æ–™åº«æœªåˆå§‹åŒ–ï¼Œç„¡æ³•æ–°å¢è¨˜éŒ„ã€‚", "error"); return;
        }
        if (!currentUserId) {
            showMessage("ç”¨æˆ¶æœªç¶“é©—è­‰ï¼Œç„¡æ³•æ–°å¢è¨˜éŒ„ã€‚", "error"); return;
        }
        if (!submitButton) return;
        submitButton.disabled = true;
        submitButton.classList.add('button-loading');
        if (!submitButton.dataset.originalContent) {
            submitButton.dataset.originalContent = submitButton.innerHTML;
        }
        submitButton.innerHTML = `<div class="loading-spinner-small"></div><span>è¨˜éŒ„ä¸­...</span>`;

        try {
            const newEntry = { teamMember, entryDate, clockOutTime, notes, createdAt: serverTimestamp(), addedBy: currentUserId };
            await addDoc(clockOutCollectionRef, newEntry);
            showMessage("ä¸‹ç­æ™‚é–“å·²æˆåŠŸè¨˜éŒ„ï¼", "success");
            if (leaveForm) leaveForm.reset();
            setCurrentDateTime();
        } catch (error) {
            console.error("æ–°å¢ä¸‹ç­æ™‚é–“è¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
            showMessage("æ–°å¢ä¸‹ç­æ™‚é–“è¨˜éŒ„å¤±æ•—ã€‚è«‹å†è©¦ä¸€æ¬¡ã€‚" + error.message, "error");
        } finally {
            submitButton.disabled = false;
            submitButton.classList.remove('button-loading');
            submitButton.innerHTML = submitButton.dataset.originalContent || `<span>è¨˜éŒ„æ™‚é–“</span>`;
        }
    }

    function fetchAndDisplayEntries() {
        if (!db || !clockOutCollectionRef || !loadingEntries || !noEntries || !leaveTable || !leaveList || !overallReviewButton) {
            console.error("ä¸€å€‹æˆ–å¤šå€‹ UI å…ƒç´ æœªèƒ½åœ¨ fetchAndDisplayEntries ä¸­æ‰¾åˆ°ã€‚");
            return;
        }
        if (!currentUserId) {
            console.warn("ç”¨æˆ¶å°šæœªé©—è­‰ï¼Œå»¶é²ç²å–ã€‚"); return;
        }

        loadingEntries.classList.remove('hidden');
        noEntries.classList.add('hidden');
        leaveTable.classList.add('hidden');
        leaveList.innerHTML = '';

        const q = query(clockOutCollectionRef, orderBy("entryDate", "desc"));

        if (unsubscribeClockOutListener) unsubscribeClockOutListener();

        unsubscribeClockOutListener = onSnapshot(q, (querySnapshot) => {
            loadingEntries.classList.add('hidden');
            allFetchedEntries = [];
            querySnapshot.forEach((doc) => {
                allFetchedEntries.push({ id: doc.id, ...doc.data() });
            });

            allFetchedEntries.sort((a, b) => {
                if (a.entryDate > b.entryDate) return -1; if (a.entryDate < b.entryDate) return 1;
                if (a.clockOutTime && b.clockOutTime) { if (a.clockOutTime > b.clockOutTime) return -1; if (a.clockOutTime < b.clockOutTime) return 1; }
                else if (a.clockOutTime) return -1; else if (b.clockOutTime) return 1;
                if (a.createdAt && b.createdAt) return b.createdAt.toMillis() - a.createdAt.toMillis();
                else if (a.createdAt) return -1; else if (b.createdAt) return 1;
                return 0;
            });

            if (allFetchedEntries.length === 0) {
                noEntries.classList.remove('hidden');
                leaveTable.classList.add('hidden');
                overallReviewButton.disabled = true;
            } else {
                noEntries.classList.add('hidden');
                leaveTable.classList.remove('hidden');
                renderEntries(allFetchedEntries);
                overallReviewButton.disabled = false;
            }
        }, (error) => {
            console.error("ç²å–ä¸‹ç­æ™‚é–“è¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
            showMessage("ç²å–ä¸‹ç­æ™‚é–“è¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤: " + error.message, "error");
            loadingEntries.classList.add('hidden');
            noEntries.textContent = "è¼‰å…¥è¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚";
            noEntries.classList.remove('hidden');
            overallReviewButton.disabled = true;
        });
        console.log("å·²é™„åŠ æ–°çš„ Firestore ç›£è½å™¨ã€‚");
    }

    function renderEntries(entriesToRender) {
        if(!leaveList) return;
        leaveList.innerHTML = '';
        entriesToRender.forEach(entry => {
            const row = leaveList.insertRow();
            row.insertCell().textContent = entry.entryDate;
            row.insertCell().textContent = entry.teamMember;
            row.insertCell().textContent = entry.clockOutTime || '-';

            const notesCell = row.insertCell();
            notesCell.textContent = entry.notes || '-';
            notesCell.classList.add('text-sm', 'text-gray-500', 'max-w-[150px]');
            if (entry.notes && entry.notes.length > 25) {
                notesCell.title = entry.notes;
                notesCell.textContent = entry.notes.substring(0, 25) + '...';
            } else {
                notesCell.classList.add('truncate');
            }

            const suggestionCell = row.insertCell();
            const suggestionButtonId = `suggestBtn-${entry.id}`;
            const suggestionButtonElement = document.createElement('button');
            suggestionButtonElement.id = suggestionButtonId;
            suggestionButtonElement.innerHTML = `<span>ğŸ’¡</span>`;
            suggestionButtonElement.title = "ç²å–é¼ ç‹å»ºè­°";
            suggestionButtonElement.classList.add('p-1', 'rounded-md', 'bg-yellow-400', 'hover:bg-yellow-500', 'text-white', 'text-xs', 'flex', 'items-center', 'justify-center');
            suggestionButtonElement.onclick = () => getClockOutSuggestion(entry.teamMember, entry.entryDate, entry.clockOutTime, entry.notes || '', suggestionButtonId);
            suggestionCell.appendChild(suggestionButtonElement);

            const actionsCell = row.insertCell();
            const deleteButtonElement = document.createElement('button');
            deleteButtonElement.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500 hover:text-red-700" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>`;
            deleteButtonElement.classList.add('p-1', 'rounded');
            deleteButtonElement.title = "åˆªé™¤è¨˜éŒ„";
            deleteButtonElement.onclick = () => openConfirmationModal('åˆªé™¤ä¸‹ç­è¨˜éŒ„', `æ‚¨ç¢ºå®šè¦åˆªé™¤ ${entry.teamMember} æ–¼ ${entry.entryDate} çš„ä¸‹ç­è¨˜éŒ„å—ï¼Ÿ`, () => deleteEntry(entry.id));
            actionsCell.appendChild(deleteButtonElement);
        });
    }

    async function deleteEntry(entryId) {
        if (!db || !clockOutCollectionRef) {
            showMessage("è³‡æ–™åº«æœªåˆå§‹åŒ–ï¼Œç„¡æ³•åˆªé™¤è¨˜éŒ„ã€‚", "error"); return;
        }
        try {
            const entryDocRef = doc(clockOutCollectionRef, entryId);
            await deleteDoc(entryDocRef);
            showMessage("è¨˜éŒ„å·²æˆåŠŸåˆªé™¤ã€‚", "success");
        } catch (error) {
            console.error("åˆªé™¤è¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
            showMessage("åˆªé™¤è¨˜éŒ„å¤±æ•—: " + error.message, "error");
        }
    }

    // --- Gemini API Call (Now through Firebase Functions) ---
    async function callGeminiAPI(promptText, buttonElement, originalButtonHTML, modalType = 'individual') {
        if (buttonElement) {
            buttonElement.disabled = true;
            buttonElement.classList.add('button-loading');
            if (!buttonElement.dataset.originalContent) {
                buttonElement.dataset.originalContent = originalButtonHTML || buttonElement.innerHTML;
            }
            buttonElement.innerHTML = `<div class="loading-spinner-small"></div><span>æ€è€ƒä¸­...</span>`;
        }
        openSuggestionModal(modalType);

        if (!functionsService) { // *** æª¢æŸ¥ Functions æœå‹™æ˜¯å¦å·²åˆå§‹åŒ– ***
            console.error("Firebase Functions service is not initialized.");
            if(suggestionText) suggestionText.textContent = "éŒ¯èª¤ï¼šå¾Œç«¯ AI æœå‹™æœªåˆå§‹åŒ–ã€‚";
            if(suggestionLoading) suggestionLoading.style.display = 'none';
            if (buttonElement) {
                buttonElement.disabled = false;
                buttonElement.classList.remove('button-loading');
                buttonElement.innerHTML = buttonElement.dataset.originalContent || originalButtonHTML;
            }
            return;
        }

        // *** å‘¼å«æ‚¨çš„é›²ç«¯å‡½å¼ ***
        const callGeminiRatKingFunction = httpsCallable(functionsService, 'callGeminiRatKing');
        console.log("Calling backend function 'callGeminiRatKing' with prompt:", promptText);

        try {
            // å°‡ promptText ä½œç‚º data å‚³éçµ¦å¾Œç«¯å‡½å¼
            const result = await callGeminiRatKingFunction({ promptText: promptText });
            // å¾Œç«¯å‡½å¼å›å‚³çš„è³‡æ–™åœ¨ result.data.text (æ ¹æ“šæˆ‘å€‘å¾Œç«¯å‡½å¼çš„è¨­è¨ˆ)
            const generatedText = result.data.text;

            if (modalType === 'note') {
                if(suggestionText) suggestionText.innerHTML = '';
                const suggestions = generatedText.split('\n').filter(s => s.trim() !== '');
                if (suggestions.length > 0) {
                    suggestions.forEach(sText => {
                        const suggItem = document.createElement('button');
                        suggItem.textContent = sText;
                        suggItem.classList.add('note-suggestion-item');
                        suggItem.onclick = () => {
                            if(notesInput) notesInput.value = sText;
                            window.closeSuggestionModal();
                        };
                        if(suggestionText) suggestionText.appendChild(suggItem);
                    });
                } else {
                     if(suggestionText) suggestionText.textContent = "é¼ ç‹æš«æ™‚æ²’æœ‰å‚™è¨»éˆæ„Ÿï¼Œè«‹é¼ ç‹å¤§äººè‡ªè¡Œç™¼æ®ï½";
                }
            } else {
                if(suggestionText) suggestionText.textContent = generatedText;
            }
        } catch (error) {
            console.error("å‘¼å«å¾Œç«¯ AI æœå‹™æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
            if(suggestionText) suggestionText.textContent = `å“å‘€ï¼é¼ ç‹ AI æœå‹™å‡ºéŒ¯äº†ï¼š${error.message}`;
            showMessage("ç„¡æ³•ç²å–é¼ ç‹å›è¦†ï¼š" + error.message, "error");
        } finally {
            if(suggestionLoading) suggestionLoading.style.display = 'none';
            if (buttonElement) {
                buttonElement.disabled = false;
                buttonElement.classList.remove('button-loading');
                buttonElement.innerHTML = buttonElement.dataset.originalContent || originalButtonHTML;
            }
        }
    }

    async function getClockOutSuggestion(teamMember, entryDate, clockOutTime, notes, buttonId) {
        const suggestionButtonElement = document.getElementById(buttonId);
        const originalButtonHTML = `<span>ğŸ’¡</span>`;
        let promptText = `ä½ æ˜¯ã€Œå››å¤§é¼ ç‹ä¸‹ç­æº–å‚™ã€App çš„ AI åŠ©æ‰‹ï¼Œé¢¨æ ¼é¢¨è¶£å¹½é»˜ï¼Œç¨±å‘¼ä½¿ç”¨è€…ç‚ºã€Œé¼ ç‹ã€ã€‚åœ˜éšŠæˆå“¡ ${teamMember} å‰›å‰›åœ¨ ${entryDate} çš„ ${clockOutTime} æ‰“å¡ä¸‹ç­ã€‚`;
        if (notes && notes.trim() !== '') promptText += `ä»–/å¥¹çš„ä¸‹ç­å‚™è¨»æ˜¯ï¼šã€Œ${notes}ã€ã€‚`;
        else promptText += `ä»–/å¥¹æ²’æœ‰ç•™ä¸‹å‚™è¨»ã€‚`;
        promptText += `è«‹æ ¹æ“šé€™äº›è³‡è¨Šï¼Œç”¨è¼•é¬†å¹½é»˜çš„é¼ ç‹é¢¨æ ¼ï¼Œçµ¦ ${teamMember} ä¸€å¥ç°¡çŸ­çš„ä¸‹ç­å¾Œçš„å»ºè­°æˆ–æ‰“æ°£çš„è©±ã€‚è«‹ç”¨ç¹é«”ä¸­æ–‡ï¼Œä¸¦ä¸”ä¸è¶…é60å€‹å­—ã€‚`;
        await callGeminiAPI(promptText, suggestionButtonElement, originalButtonHTML, 'individual');
    }

    async function getOverallTeamReview() {
        if (!overallReviewButton) return;
        if (allFetchedEntries.length === 0) {
            showMessage("ç›®å‰æ²’æœ‰è¨˜éŒ„å¯ä¾›ç¸½è©•ã€‚", "warning"); return;
        }
        const originalButtonHTML = `<span>âœ¨ ç²å–è¿‘æœŸè¡¨ç¾ç¸½è©•</span>`;
        let recordsSummary = allFetchedEntries.slice(0, 15).map(e =>
            `${e.teamMember} æ–¼ ${e.entryDate} ${e.clockOutTime} ä¸‹ç­${e.notes ? ` (å‚™è¨»: ${e.notes.substring(0, 20)})${e.notes.length > 20 ? '...' : ''}` : ''}`
        ).join("ï¼› ");

        if (allFetchedEntries.length > 15) recordsSummary += `...ç­‰å…± ${allFetchedEntries.length} ç­†è¨˜éŒ„ã€‚`;

        let promptText = `ä½ æ˜¯ã€Œå››å¤§é¼ ç‹ä¸‹ç­æº–å‚™ã€App çš„ AI åŠ©æ‰‹ï¼Œé¢¨æ ¼é¢¨è¶£å¹½é»˜ï¼Œç¨±å‘¼ä½¿ç”¨è€…ç‚ºã€Œé¼ ç‹ã€ã€‚ä»¥ä¸‹æ˜¯åœ˜éšŠæˆå“¡è¿‘æœŸçš„ä¸‹ç­æ‰“å¡è¨˜éŒ„æ‘˜è¦ï¼šã€Œ${recordsSummary}ã€ã€‚è«‹æ ¹æ“šé€™äº›è¨˜éŒ„ï¼Œç”¨è¼•é¬†å¹½é»˜çš„é¼ ç‹é¢¨æ ¼ï¼Œå°åœ˜éšŠè¿‘æœŸçš„æ•´é«”è¾›å‹ç¨‹åº¦åšä¸€å€‹ç°¡çŸ­ç¸½è©•ï¼ˆä¾‹å¦‚èª°æœ€æ™šèµ°ï¼Œå¹³å‡ä¸‹ç­æ™‚é–“å¦‚ä½•ç­‰ç­‰ï¼‰ï¼Œä¸¦çµ¦äºˆä¸€äº›æ‰“æ°£çš„è©±ã€‚è«‹ç”¨ç¹é«”ä¸­æ–‡ï¼Œä¸¦ä¸”ç¸½å­—æ•¸ä¸è¶…é120å­—ã€‚`;
        await callGeminiAPI(promptText, overallReviewButton, originalButtonHTML, 'overall');
    }

    async function fetchNoteSuggestions() {
        if (!getNoteSuggestionButton) return;
        const originalButtonHTML = `<span>ğŸ’¡ å‚™è¨»å»ºè­°</span>`;
        const promptText = `ä½ æ˜¯ã€Œå››å¤§é¼ ç‹ä¸‹ç­æº–å‚™ã€App çš„ AI åŠ©æ‰‹ï¼Œé¢¨æ ¼é¢¨è¶£å¹½é»˜ã€‚è«‹æä¾›3-4å€‹ç°¡çŸ­çš„ä¸‹ç­å‚™è¨»ä¾‹å¥ï¼Œç”¨æ–¼è¨˜éŒ„ä¸‹ç­æ™‚çš„å¿ƒæƒ…æˆ–äº‹ç”±ã€‚é¢¨æ ¼å¯ä»¥æ˜¯æœ‰é»æŠ±æ€¨å·¥ä½œã€æœŸå¾…æ”¾é¬†ã€æˆ–è¨˜éŒ„ç‰¹æ®Šäº‹é …ã€‚ä¾‹å¦‚ï¼šã€Œçµ‚æ–¼æå®šé‚£å€‹é¬¼Bugï¼Œé–ƒäººäº†ï¼ã€ã€ã€Œä»Šå¤©ææ—©é–‹æºœï¼Œé¼ è¼©çš„å¿«æ¨‚å°±æ˜¯é€™éº¼æ¨¸å¯¦ç„¡è¯ï¼ã€ã€ã€Œè¢«å®¢æˆ¶çºåˆ°ç¾åœ¨ï¼Œç´¯ç™±ã€‚ã€ã€‚è«‹ç”¨ç¹é«”ä¸­æ–‡ï¼Œæ¯å€‹ä¾‹å¥ä¸€è¡Œï¼Œä¸è¦æœ‰ç·¨è™Ÿæˆ–å¼•è™Ÿã€‚`;
        await callGeminiAPI(promptText, getNoteSuggestionButton, originalButtonHTML, 'note');
    }

    async function fetchExcuse() {
        if (!getExcuseButton) return;
        const originalButtonHTML = `<span>ğŸ‘‘ è³œæˆ‘ä¸‹ç­ç¥è—‰å£ï¼</span>`;
        const promptText = `ä½ æ˜¯ã€Œå››å¤§é¼ ç‹ä¸‹ç­æº–å‚™ã€App çš„ AI åŠ©æ‰‹ï¼Œé¢¨æ ¼é¢¨è¶£å¹½é»˜ï¼Œç¨±å‘¼ä½¿ç”¨è€…ç‚ºã€Œé¼ ç‹ã€ã€‚é¼ ç‹æˆ‘ä»Šå¤©æƒ³æº–æ™‚ï¼ˆæˆ–ææ—©ï¼‰ä¸‹ç­ï¼Œè«‹è³œæˆ‘ä¸€å€‹çµ•å¦™çš„ä¸‹ç­è—‰å£ï¼Œè¦å¤ å‰µæ„ã€å¤ å¹½é»˜ï¼Œæœ€å¥½è®“è€é—†æˆ–åŒäº‹è½äº†éƒ½ç„¡æ³•åé§ï¼Œç”šè‡³æœƒå¿ƒä¸€ç¬‘ï¼è«‹ç”¨ç¹é«”ä¸­æ–‡ï¼Œä¸€å¥è©±å°±å¥½ï¼Œå¤§ç´„30-70å­—ã€‚`;
        await callGeminiAPI(promptText, getExcuseButton, originalButtonHTML, 'excuse');
    }

    // --- Event Listeners ---
    if (leaveForm) leaveForm.addEventListener('submit', (e) => {
        e.preventDefault();
        if (!leaveForm.teamMember || !entryDateInput || !clockOutTimeInput || !notesInput) return;
        const teamMember = leaveForm.teamMember.value;
        const entryDateValue = entryDateInput.value;
        const clockOutTimeValue = clockOutTimeInput.value;
        const notesValue = notesInput.value.trim();
        if (!entryDateValue) { showMessage("è«‹é¸æ“‡æ—¥æœŸã€‚", "warning"); return; }
        if (!clockOutTimeValue) { showMessage("è«‹è¼¸å…¥ä¸‹ç­æ™‚é–“ã€‚", "warning"); return; }
        addEntry(teamMember, entryDateValue, clockOutTimeValue, notesValue);
    });

    if (overallReviewButton) overallReviewButton.addEventListener('click', getOverallTeamReview);
    if (getNoteSuggestionButton) getNoteSuggestionButton.addEventListener('click', fetchNoteSuggestions);
    if (getExcuseButton) getExcuseButton.addEventListener('click', fetchExcuse);

    // --- Initial Load ---
    document.addEventListener('DOMContentLoaded', () => {
        setCurrentDateTime();
        initializeFirebaseServices(); // åˆå§‹åŒ– Firebaseï¼Œç¾åœ¨ä¹Ÿæœƒåˆå§‹åŒ– Functions æœå‹™
        if (overallReviewButton) overallReviewButton.disabled = true;
    });

</script> 
</body>
</html>

